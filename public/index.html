<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Claude View</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --text: #e0e0e0;
    --text-dim: #8888aa;
    --accent: #7c3aed;
    --green: #22c55e;
    --amber: #f59e0b;
    --red: #ef4444;
    --blue: #3b82f6;
    --user-green: #166534;
    --idle-yellow: #854d0e;
  }
  html, body {
    height: 100%; overflow: hidden;
    background: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    font-size: 15px;
  }
  #app { display: flex; flex-direction: column; height: 100%; }

  /* Top bar */
  #topbar {
    background: var(--surface); padding: 12px 16px;
    display: flex; align-items: center; gap: 10px;
    border-bottom: 1px solid #ffffff12;
    flex-shrink: 0;
  }
  #conn-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--red); flex-shrink: 0;
    transition: background 0.3s;
  }
  #conn-dot.connected { background: var(--green); }
  #topbar-title { font-weight: 600; font-size: 16px; }
  #topbar-status {
    margin-left: auto; font-size: 13px; color: var(--text-dim);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 50%;
  }

  /* Message area */
  #messages {
    flex: 1; overflow-y: auto; padding: 12px 16px;
    display: flex; flex-direction: column; gap: 8px;
    -webkit-overflow-scrolling: touch;
  }

  .msg {
    max-width: 90%; padding: 10px 14px; border-radius: 12px;
    line-height: 1.4; word-break: break-word; animation: fadeIn 0.2s;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* Activity: dimmed, left-aligned */
  .msg.activity {
    background: #ffffff08; color: var(--text-dim); font-size: 13px;
    border-radius: 8px; padding: 6px 12px; align-self: flex-start;
  }

  /* Notifications by level */
  .msg.notification { align-self: flex-start; }
  .msg.notification.info { background: #1e3a5f; border-left: 3px solid var(--blue); }
  .msg.notification.warning { background: #3d2e0a; border-left: 3px solid var(--amber); }
  .msg.notification.error { background: #3d0a0a; border-left: 3px solid var(--red); }
  .msg.notification.success { background: #0a3d1a; border-left: 3px solid var(--green); }

  /* Question: purple card */
  .msg.question {
    background: #2d1b69; border: 1px solid var(--accent);
    align-self: flex-start; width: 95%;
  }
  .msg.question.answered { opacity: 0.5; border-color: #555; }
  .question-text { margin-bottom: 10px; font-weight: 500; }
  .question-options { display: flex; flex-wrap: wrap; gap: 8px; }
  .question-options button {
    background: var(--accent); color: white; border: none;
    padding: 8px 16px; border-radius: 20px; font-size: 14px;
    cursor: pointer; transition: background 0.15s;
  }
  .question-options button:active { background: #6d28d9; }
  .question-options button:disabled { opacity: 0.4; cursor: default; }

  /* User messages: right-aligned */
  .msg.user {
    background: var(--user-green); align-self: flex-end;
    border-radius: 12px 12px 4px 12px;
  }

  /* Status updates */
  .msg.status {
    background: transparent; color: var(--text-dim);
    font-size: 12px; text-align: center; align-self: center;
    padding: 4px 12px;
  }

  /* Idle prompt */
  .msg.idle {
    background: #3d2e0a; border: 1px solid var(--amber);
    align-self: center; text-align: center; font-size: 14px;
  }

  /* Timestamp */
  .msg-time { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

  /* Input bar */
  #inputbar {
    background: var(--surface); padding: 10px 12px;
    display: flex; gap: 8px; align-items: center;
    border-top: 1px solid #ffffff12;
    flex-shrink: 0;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
  }
  #input {
    flex: 1; background: var(--bg); color: var(--text);
    border: 1px solid #ffffff20; border-radius: 22px;
    padding: 10px 16px; font-size: 15px; outline: none;
    font-family: inherit;
  }
  #input:focus { border-color: var(--accent); }
  #send-btn {
    background: var(--accent); color: white; border: none;
    width: 42px; height: 42px; border-radius: 50%;
    font-size: 20px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
  }
  #send-btn:active { background: #6d28d9; }
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div id="conn-dot"></div>
    <div id="topbar-title">Claude View</div>
    <div id="topbar-status"></div>
  </div>
  <div id="messages"></div>
  <div id="inputbar">
    <input id="input" type="text" placeholder="Send instruction..." autocomplete="off" />
    <button id="send-btn">&#9654;</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function() {
  // Get token from URL hash
  const token = location.hash.slice(1);
  if (!token) {
    const warn = document.createElement("div");
    warn.className = "msg notification warning";
    warn.style.marginTop = "40px";
    warn.style.textAlign = "center";
    warn.textContent = "No auth token. Add #TOKEN to the URL.";
    document.getElementById("messages").appendChild(warn);
    return;
  }

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send-btn");
  const connDot = document.getElementById("conn-dot");
  const statusText = document.getElementById("topbar-status");

  let hasPendingQuestion = false;
  let pendingQuestionId = null;
  let seenIds = new Set();
  let titleFlashInterval = null;
  const originalTitle = document.title;

  // Audio context for beeps
  let audioCtx = null;
  function beep() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.frequency.value = 660;
      gain.gain.value = 0.3;
      osc.start(); osc.stop(audioCtx.currentTime + 0.15);
      setTimeout(function() {
        const osc2 = audioCtx.createOscillator();
        const gain2 = audioCtx.createGain();
        osc2.connect(gain2); gain2.connect(audioCtx.destination);
        osc2.frequency.value = 880;
        gain2.gain.value = 0.3;
        osc2.start(); osc2.stop(audioCtx.currentTime + 0.15);
      }, 200);
    } catch(e) { /* audio not available */ }
  }

  function flashTitle(text) {
    if (titleFlashInterval) return;
    let on = true;
    titleFlashInterval = setInterval(function() {
      document.title = on ? text : originalTitle;
      on = !on;
    }, 800);
    window.addEventListener("focus", stopFlash, { once: true });
  }
  function stopFlash() {
    if (titleFlashInterval) { clearInterval(titleFlashInterval); titleFlashInterval = null; }
    document.title = originalTitle;
  }

  function formatTime(ts) {
    return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function autoScroll() {
    requestAnimationFrame(function() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  function updatePlaceholder() {
    inputEl.placeholder = hasPendingQuestion
      ? "Reply to question..."
      : "Send instruction...";
  }

  function createTimeEl(ts) {
    const el = document.createElement("div");
    el.className = "msg-time";
    el.textContent = formatTime(ts);
    return el;
  }

  function renderMessage(msg) {
    if (seenIds.has(msg.id)) return;
    seenIds.add(msg.id);

    const div = document.createElement("div");
    div.dataset.id = msg.id;

    if (msg.type === "activity") {
      div.className = "msg activity";
      const textNode = document.createTextNode(msg.summary || (msg.tool + ": (action)"));
      div.appendChild(textNode);
      div.appendChild(createTimeEl(msg.ts));
    }
    else if (msg.type === "notification") {
      div.className = "msg notification " + (msg.level || "info");
      const textEl = document.createElement("span");
      textEl.textContent = msg.message;
      div.appendChild(textEl);
      div.appendChild(createTimeEl(msg.ts));
    }
    else if (msg.type === "question") {
      div.className = "msg question" + (msg.answered ? " answered" : "");

      var qText = document.createElement("div");
      qText.className = "question-text";
      qText.textContent = msg.question;
      div.appendChild(qText);

      if (msg.options && msg.options.length && !msg.answered) {
        var optContainer = document.createElement("div");
        optContainer.className = "question-options";
        msg.options.forEach(function(opt) {
          var btn = document.createElement("button");
          btn.textContent = opt;
          btn.addEventListener("click", function() { respondToQuestion(opt); });
          optContainer.appendChild(btn);
        });
        div.appendChild(optContainer);
      }

      div.appendChild(createTimeEl(msg.ts));

      if (!msg.answered) {
        hasPendingQuestion = true;
        pendingQuestionId = msg.id;
        updatePlaceholder();
        beep();
        flashTitle("Question from Claude");
      }
    }
    else if (msg.type === "user") {
      div.className = "msg user";
      var userText = document.createElement("span");
      userText.textContent = msg.message;
      div.appendChild(userText);
      div.appendChild(createTimeEl(msg.ts));
    }
    else if (msg.type === "status") {
      div.className = "msg status";
      div.textContent = msg.status;
    }
    else if (msg.type === "idle") {
      div.className = "msg idle";
      var idleText = document.createElement("span");
      idleText.textContent = "Claude is idle. Send an instruction to continue.";
      div.appendChild(idleText);
      div.appendChild(createTimeEl(msg.ts));
    }

    messagesEl.appendChild(div);
    autoScroll();
  }

  // Respond to question
  function respondToQuestion(answer) {
    fetch("/api/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Auth-Token": token },
      body: JSON.stringify({ answer: String(answer) }),
    }).then(function() {
      hasPendingQuestion = false;
      pendingQuestionId = null;
      updatePlaceholder();
      // Disable buttons on answered questions
      var btns = document.querySelectorAll(".msg.question:not(.answered) button");
      btns.forEach(function(b) { b.disabled = true; });
      var cards = document.querySelectorAll(".msg.question:not(.answered)");
      cards.forEach(function(el) { el.classList.add("answered"); });
    });
  }
  window.respondToQuestion = respondToQuestion;

  // Send message
  function send() {
    var text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = "";

    if (hasPendingQuestion) {
      respondToQuestion(text);
    } else {
      fetch("/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Auth-Token": token },
        body: JSON.stringify({ message: text }),
      });
    }
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", function(e) {
    if (e.key === "Enter") { e.preventDefault(); send(); }
  });

  // Socket.IO
  var socket = io({ auth: { token: token }, reconnection: true, reconnectionDelay: 1000 });

  socket.on("connect", function() {
    connDot.classList.add("connected");
  });
  socket.on("disconnect", function() {
    connDot.classList.remove("connected");
  });

  socket.on("init", function(state) {
    messagesEl.textContent = "";
    seenIds.clear();
    hasPendingQuestion = state.hasPendingQuestion;
    pendingQuestionId = state.pendingQuestionId;
    if (state.status) statusText.textContent = state.status;
    updatePlaceholder();
    state.messages.forEach(renderMessage);
  });

  socket.on("message", function(msg) {
    renderMessage(msg);
    if (msg.timedOut && msg.type === "question") {
      hasPendingQuestion = false;
      pendingQuestionId = null;
      updatePlaceholder();
    }
  });

  socket.on("status", function(s) {
    statusText.textContent = s;
  });
})();
</script>
</body>
</html>
